
```{r}
url <- "https://www.ebi.ac.uk/ipd/imgt/hla/about/statistics/"

library(rvest)
library(janitor)
library(tidyverse)

# version 3.6.1 of the database at the time of publication
url <- "https://www.ebi.ac.uk/ipd/imgt/hla/about/statistics/"
page <- read_html(url)
tables <- page %>% html_table(fill = TRUE)
hla_tables <- tables[[1]]
 hla_tables <- hla_tables[-c(1:5),]

table1 <- hla_tables %>% .[c(1,2,3,4),] %>% t(.) %>% as.data.frame(.) %>% remove_rownames(.) %>% row_to_names(row_number = 1) %>% drop_na() %>% .[.$Gene != '',] %>% rename(Category = 1)
table2 <- hla_tables %>% .[c(6,7,8,9),]%>% t(.) %>% as.data.frame(.) %>% remove_rownames(.) %>% row_to_names(row_number = 1) %>% drop_na() %>% .[.$Gene != '',] %>% rename(Category = 1)
table3 <- hla_tables %>% .[c(11,12,13,14),]%>% t(.) %>% as.data.frame(.) %>% remove_rownames(.) %>% row_to_names(row_number = 1) %>% drop_na() %>% .[.$Gene != '',] %>% rename(Category = 1)
table4 <- hla_tables %>% .[c(16,17,18,19),]%>% t(.) %>% as.data.frame(.) %>% remove_rownames(.) %>% row_to_names(row_number = 1) %>% drop_na() %>% .[.$Gene != '',] %>% rename(Category = 1)
table5 <- hla_tables %>% .[c(21,22,23,24),]%>% t(.) %>% as.data.frame(.) %>% remove_rownames(.) %>% row_to_names(row_number = 1) %>% drop_na() %>% .[.$Gene != '',] %>% rename(Category = 1)

parsed_imgt_hla_database_statistics <- rbind(table1,table2,table3,table4,table5)
parsed_imgt_hla_database_statistics$Alleles <- as.numeric(parsed_imgt_hla_database_statistics$Alleles)
parsed_imgt_hla_database_statistics$Proteins <- as.numeric(parsed_imgt_hla_database_statistics$Proteins)

#filter out non-expressed genes, thereby removing pseudogenes
parsed_imgt_hla_database_statistics <- parsed_imgt_hla_database_statistics %>% filter(Proteins != 0)
# remove - DRB Alleles alleles from the cateogry column for simplicity
parsed_imgt_hla_database_statistics$Category <- gsub(' - DRB Alleles', '', parsed_imgt_hla_database_statistics$Category)
# drop the row containing total number of DRB alleles
parsed_imgt_hla_database_statistics <- parsed_imgt_hla_database_statistics %>% filter(Gene !='DRB')

library(forcats)

parsed_imgt_hla_database_statistics <- parsed_imgt_hla_database_statistics %>%
  mutate(Gene = factor(Gene, levels = Gene[order(as.numeric(Proteins))]))


colnames(parsed_imgt_hla_database_statistics)[c(3,4)] <- c('Number of alleles','Number of proteins')



plot <- parsed_imgt_hla_database_statistics %>% pivot_longer(., cols = c('Number of alleles','Number of proteins'), names_to = 'stratification_type', values_to = 'quantity') %>%
  ggplot(., aes(x = quantity, y = Gene, fill = Category)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ stratification_type) +
  theme_minimal() +
  labs(x = "Quantity",
       y = "Gene")+
  scale_fill_manual(values = c('#317cc1','#c33e96','#e78729'))+
  theme(
    text = element_text(size = 15),        # base text size
    axis.title = element_text(size = 16),  # axis titles
    axis.text = element_text(size = 14),   # axis tick labels
    strip.text = element_text(size = 16),  # facet labels
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
    theme(legend.position="bottom")


plot
# Save to file
ggsave(
  filename = "/Users/c1530015/Documents/HLA_AD_WES_results/Review_figure1_C.png",
  plot = plot,
  width = 7.5,        # inches
  height = 6,        # inches
  dpi = 1000,          # high resolution
 bg = "white" 
  )

```

